# Руководство по развертыванию мониторинга с помощью Ansible

## Обзор
Данный документ описывает процесс развертывания системы мониторинга с использованием различных экспортеров Prometheus (Node Exporter, MySQL Exporter, Blackbox Exporter, cAdvisor) с помощью Ansible.

### Примечание по архитектуре
По умолчанию все роли и конфигурации в этом репозитории адаптированы для ARM-совместимых Linux-систем. Это обеспечивает совместимость с широким спектром современных серверов, включая те, которые работают на архитектуре ARM.

Если в вашей среде используется стандартная архитектура x86, вы можете легко адаптировать развертывание, изменив соответствующие архитектурно-зависимые переменные в файлах. Обратитесь к разделу **Configuration** для получения более подробной информации.

## Структура проекта
```
.
├── ansible.cfg
├── inventory.ini
├── group_vars
│   └── all.yml
├── roles
│   ├── blackbox_exporter
│   ├── cadvisor
│   ├── mysql_exporter
│   └── node_exporter
└── site.yml
```

## Предварительные требования

### Локальное окружение
1. Установленный Ansible (рекомендуемая версия 2.18 или выше)
2. SSH-ключи для доступа к хостам
3. Настроенное сетевое подключение к целевым хостам

### Конфигурация целевых серверов
1. Операционная система: Linux
2. Открытый SSH-доступ
3. Пользователь с правами sudo
4. Для MySQL Exporter: настроенный доступ к базе данных

## Конфигурация

### 1. Настройка инвентарного файла (inventory.ini)
Убедитесь, что в файле inventory.ini указаны корректные:
- IP-адреса или хостнеймы
- Пути к SSH-ключам
- Имена пользователей для подключения

### 2. Проверка переменных
В файле `group_vars/all.yml` настройте:
- Версии экспортеров
- Параметры подключения к MySQL
- Архитектуру целевых систем

## Запуск развертывания

### Проверка доступности хостов
Перед запуском плейбука проверьте доступность хостов:
```bash
ansible all -i inventory.ini -m ping
```

### Варианты запуска

1. **Развертывание на всех хостах**
```bash
ansible-playbook site.yml
```

2. **Развертывание по окружениям**
```bash
# Развертывание в dev-окружении
ansible-playbook site.yml --limit dev

# Развертывание в stage-окружении
ansible-playbook site.yml --limit stage

# Развертывание в prod-окружении
ansible-playbook site.yml --limit prod
```

3. **Развертывание по облачным провайдерам**
```bash
# Только AWS серверы
ansible-playbook site.yml --limit aws

# Только Oracle серверы
ansible-playbook site.yml --limit oracle
```

4. **Развертывание на конкретном хосте**
```bash
ansible-playbook site.yml --limit server-hostname
```

### Дополнительные параметры запуска

- `--check`: Тестовый запуск без внесения изменений
```bash
ansible-playbook site.yml --check
```

- `--diff`: Показать изменения в файлах
```bash
ansible-playbook site.yml --diff
```

- `-v` или `-vv`: Подробный вывод для отладки
```bash
ansible-playbook site.yml -vv
```

## Проверка установки

После успешного развертывания проверьте:

1. Статус сервисов:
```bash
ansible all -i inventory.ini -m shell -a "systemctl status node_exporter"
ansible all -i inventory.ini -m shell -a "systemctl status mysqld_exporter"
ansible all -i inventory.ini -m shell -a "systemctl status blackbox_exporter"
```

2. Доступность метрик:
- Node Exporter: http://server:9100/metrics
- MySQL Exporter: http://server:9104/metrics
- Blackbox Exporter: http://server:9115/metrics
- cAdvisor: http://server:8080/metrics

## Устранение неполадок

### Общие проблемы и решения

1. **Ошибка подключения SSH**
- Проверьте правильность путей к SSH-ключам
- Убедитесь в корректности прав доступа к ключам (600)
- Проверьте сетевую доступность серверов

2. **Ошибки установки экспортеров**
- Проверьте версии экспортеров в group_vars/all.yml
- Убедитесь в правильности архитектуры (arch) в переменных
- Проверьте доступность сети для загрузки пакетов

3. **Проблемы с MySQL Exporter**
- Проверьте корректность учетных данных MySQL
- Убедитесь в сетевой доступности базы данных
- Проверьте права пользователя базы данных

### Логи и отладка

Для подробного анализа проблем используйте:
```bash
# Просмотр логов сервиса
ansible all -i inventory.ini -m shell -a "journalctl -u node_exporter -n 50"

# Запуск плейбука с подробным выводом
ansible-playbook site.yml -vvv
```

## Обслуживание

### Обновление экспортеров

1. Измените версии в `group_vars/all.yml`
2. Запустите плейбук повторно:
```bash
ansible-playbook site.yml
```

### Резервное копирование конфигурации
Рекомендуется сохранять копии конфигурационных файлов в системе контроля версий.

## Безопасность

1. Регулярно обновляйте версии экспортеров
2. Используйте защищенные пароли для MySQL
3. Настройте файерволы для ограничения доступа к портам экспортеров
4. Храните конфиденциальные данные в зашифрованном виде (ansible-vault)

## Поддержка

При возникновении проблем:
1. Проверьте секцию "Устранение неполадок" в этой документации
2. Обратитесь к официальной документации экспортеров
3. Проверьте логи сервисов на целевых серверах